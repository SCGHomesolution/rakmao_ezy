<!DOCTYPE html>
<html lang="th">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>LINE LIFF Bridge</title>
  <script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
  <style>
    /* ‡πÉ‡∏ä‡πâ Prompt ‡∏î‡πâ‡∏ß‡∏¢ @import ‚Äî ‡∏ï‡πâ‡∏≠‡∏á‡∏≠‡∏¢‡∏π‡πà‡∏ö‡∏£‡∏£‡∏ó‡∏±‡∏î‡πÅ‡∏£‡∏Å‡πÉ‡∏ô <style> */
    @import url('https://fonts.googleapis.com/css2?family=Prompt:ital,wght@0,100;0,200;0,300;0,400;0,500;0,600;0,700;0,800;0,900;1,100;1,200;1,300;1,400;1,500;1,600;1,700;1,800;1,900&display=swap');

    * { box-sizing: border-box; margin: 0; padding: 0; }

    body {
      font-family: 'Prompt', 'Noto Sans Thai', system-ui, -apple-system, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, 'Noto Sans', 'Liberation Sans', sans-serif, 'Apple Color Emoji', 'Segoe UI Emoji';
      background: linear-gradient(135deg, #00c851, #00ff41);
      min-height: 100vh;
      display: flex;
      justify-content: center;
      align-items: center;
      padding: 20px;
    }

    /* ‡∏ö‡∏±‡∏á‡∏Ñ‡∏±‡∏ö‡πÉ‡∏´‡πâ‡∏õ‡∏∏‡πà‡∏°‡πÉ‡∏ä‡πâ‡∏ü‡∏≠‡∏ô‡∏ï‡πå Prompt ‡πÅ‡∏ô‡πà‡∏ô‡∏≠‡∏ô */
    button, .confirm-btn, .cancel-btn {
      font-family: 'Prompt', 'Noto Sans Thai', system-ui, -apple-system, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, 'Noto Sans', sans-serif, 'Apple Color Emoji', 'Segoe UI Emoji' !important;
    }

    .container {
      background: #fff;
      border-radius: 20px;
      padding: 30px;
      box-shadow: 0 10px 30px rgba(0,0,0,0.2);
      max-width: 400px;
      width: 100%;
      text-align: center;
    }

    .loading { display: block; }
    .user-info { display: none; }
    .redirect-info { display: none; }

    .spinner {
      border: 4px solid #f3f3f3;
      border-top: 4px solid #00c851;
      border-radius: 50%;
      width: 50px;
      height: 50px;
      animation: spin 1s linear infinite;
      margin: 0 auto 20px;
    }
    @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

    .profile-image {
      width: 100px; height: 100px; border-radius: 50%;
      object-fit: cover; margin: 0 auto 20px; border: 4px solid #00c851; display: block;
    }

    .user-name { font-size: 24px; font-weight: 700; color: #333; margin-bottom: 10px; }
    .user-id {
      font-size: 14px; color: #666; background: #f5f5f5;
      padding: 8px 12px; border-radius: 8px; margin-bottom: 30px; word-break: break-all;
    }

    .confirm-btn {
      background: #00c851; color: #fff; border: none;
      padding: 15px 30px; font-size: 18px; border-radius: 10px;
      cursor: pointer; width: 100%; margin-bottom: 15px; transition: background .3s; font-weight: 600;
    }
    .confirm-btn:hover { background: #00a844; }
    .confirm-btn:disabled { background: #ccc; cursor: not-allowed; }

    .cancel-btn {
      background: #dc3545; color: #fff; border: none;
      padding: 12px 25px; font-size: 16px; border-radius: 8px;
      cursor: pointer; width: 100%; transition: background .3s; font-weight: 600;
    }
    .cancel-btn:hover { background: #c82333; }

    .message { color: #666; font-size: 16px; line-height: 1.5; }
    .error { color: #dc3545; font-weight: 700; }
    .success { color: #00c851; font-weight: 700; }
    .redirecting { color: #ff6b35; font-weight: 700; }
    .countdown { font-size: 20px; color: #00c851; font-weight: 700; }

    .status-info {
      background: #f8f9fa; border-radius: 8px; padding: 15px; margin: 20px 0;
      font-size: 14px; text-align: center; color: #333; border-left: 4px solid #00c851; word-break: break-word;
    }

    .url-label { font-weight: 700; color: #00c851; margin-bottom: 8px; text-align: center; }
  </style>
</head>
<body>
  <div class="container">
    <!-- Loading State -->
    <div id="loading" class="loading">
      <div class="spinner"></div>
      <div id="loadingMessage" class="message">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠‡∏Å‡∏±‡∏ö LINE...</div>
    </div>

    <!-- User Info State -->
    <div id="userInfo" class="user-info">
      <img id="profileImage" class="profile-image" src="" alt="Profile Picture" />
      <div id="userName" class="user-name"></div>
      <div id="userId" class="user-id"></div>
      <button id="confirmBtn" class="confirm-btn">‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</button>
      <button id="cancelBtn" class="cancel-btn">‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å</button>
    </div>

    <!-- Redirect Info State -->
    <div id="redirectInfo" class="redirect-info">
      <div class="spinner"></div>
      <div id="redirectMessage" class="message redirecting">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÄ‡∏ï‡∏£‡∏µ‡∏¢‡∏°‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•...</div>
      <div class="url-label">‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞:</div>
      <div id="redirectUrl" class="status-info"></div>
      <div id="countdownMessage" class="message"></div>
    </div>
  </div>

  <script>
    const LIFF_ID = '2008146540-vb4OMaMV';
    const GLIDE_URL = 'https://ezyrfq.glide.page';
    let userProfile = null;

    const getQueryParam = (name) => new URLSearchParams(window.location.search).get(name) || '';

    function showLoading(message) {
      document.getElementById('loadingMessage').textContent = message;
      document.getElementById('loading').style.display = 'block';
      document.getElementById('userInfo').style.display = 'none';
      document.getElementById('redirectInfo').style.display = 'none';
    }

    function showUserInfo(profile) {
      userProfile = profile;
      const rowId = getQueryParam('rowid') || 'DT-ZC65iTlGfaqW9Ix391g';
      document.getElementById('profileImage').src =
        profile.pictureUrl ||
        'data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" width="100" height="100" viewBox="0 0 100 100"><circle cx="50" cy="50" r="50" fill="%23ddd"/><text x="50" y="55" font-family="Arial" font-size="14" fill="%23999" text-anchor="middle">No Image</text></svg>';
      document.getElementById('userName').textContent = profile.displayName || '‡πÑ‡∏°‡πà‡∏£‡∏∞‡∏ö‡∏∏‡∏ä‡∏∑‡πà‡∏≠';
      document.getElementById('userId').innerHTML =
        `User ID: ${profile.userId}<br><small style="color:#999;font-size:12px;">Row ID: ${rowId}</small>`;
      document.getElementById('loading').style.display = 'none';
      document.getElementById('userInfo').style.display = 'block';
      document.getElementById('redirectInfo').style.display = 'none';
    }

    function showRedirectInfo(message) {
      document.getElementById('redirectUrl').textContent = message;
      document.getElementById('loading').style.display = 'none';
      document.getElementById('userInfo').style.display = 'none';
      document.getElementById('redirectInfo').style.display = 'block';
    }

    function redirectToApp() {
      if (!userProfile) {
        document.getElementById('loadingMessage').innerHTML = '<span class="error">‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ</span>';
        return;
      }
      showRedirectInfo('‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Å‡∏±‡∏ö Glide App...');
      sendToGlideAPI();
    }

    async function sendToGlideAPI() {
      try {
        document.getElementById('countdownMessage').innerHTML =
          '<span class="redirecting">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏™‡πà‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ...</span>';

        const userId = userProfile.userId || '';
        const userName = userProfile.displayName || '';
        const profileImg = userProfile.pictureUrl || '';
        const rowId = getQueryParam('rowid') || 'DT-ZC65iTlGfaqW9Ix391g';

        // ‡πÉ‡∏ä‡πâ‡πÇ‡∏ó‡πÄ‡∏Ñ‡∏ô‡∏à‡∏≤‡∏Å URL ‡πÅ‡∏ó‡∏ô‡∏Æ‡∏≤‡∏£‡πå‡∏î‡πÇ‡∏Ñ‡πâ‡∏î
        const AUTH_TOKEN = getQueryParam('token');
        if (!AUTH_TOKEN) console.warn('No AUTH token provided via ?token=...');

        const apiPayload = {
          appID: "wFtUtanipzHwHsjbHCij",
          mutations: [
            {
              kind: "set-columns-in-row",
              tableName: "native-table-Iaj8OYHgkSlTKB831ukh",
              columnValues: {
                "hbHy1": userId,     // line_id
                "7TucJ": userName,   // line_name
                "rzbcg": profileImg  // line_img
              },
              rowID: rowId
            }
          ]
        };

        const response = await fetch('https://api.glideapp.io/api/function/mutateTables', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'Authorization': 'Bearer ' + AUTH_TOKEN
          },
          body: JSON.stringify(apiPayload)
        });

        if (response.ok) {
          const result = await response.json();
          console.log('API Success:', result);
          document.getElementById('countdownMessage').innerHTML =
            '<span class="success">‚úÖ ‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à!</span>';
          setTimeout(() => { forceCloseWindow(); }, 500);
        } else {
          throw new Error(`API Error: ${response.status} ${response.statusText}`);
        }
      } catch (error) {
        console.error('API Error:', error);
        document.getElementById('countdownMessage').innerHTML =
          `<span class="error">‚ùå ‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î: ${error.message}</span>`;
        setTimeout(() => {
          document.getElementById('countdownMessage').innerHTML =
            '<button onclick="sendToGlideAPI()" style="background:#dc3545;color:white;border:none;padding:10px 20px;border-radius:5px;cursor:pointer;">‡∏•‡∏≠‡∏á‡πÉ‡∏´‡∏°‡πà‡∏≠‡∏µ‡∏Å‡∏Ñ‡∏£‡∏±‡πâ‡∏á</button>';
        }, 3000);
      }
    }

    function forceCloseWindow() {
      // ‡∏ã‡πà‡∏≠‡∏ô‡∏´‡∏ô‡πâ‡∏≤‡∏ó‡∏±‡∏ô‡∏ó‡∏µ‡πÉ‡∏´‡πâ‡πÄ‡∏´‡∏°‡∏∑‡∏≠‡∏ô‡∏õ‡∏¥‡∏î‡πÅ‡∏•‡πâ‡∏ß
      try {
        document.body.style.display = 'none';
        document.documentElement.style.display = 'none';
      } catch(e){}

      // ‡∏õ‡∏¥‡∏î‡∏î‡πâ‡∏ß‡∏¢ LIFF ‡∏ñ‡πâ‡∏≤‡∏≠‡∏¢‡∏π‡πà‡πÉ‡∏ô LINE
      try {
        if (typeof liff !== 'undefined' && liff.isInClient()) liff.closeWindow();
      } catch(e){}

      // ‡∏¢‡πâ‡∏≠‡∏ô‡∏Å‡∏•‡∏±‡∏ö‡∏ñ‡πâ‡∏≤‡∏°‡∏µ history
      try { if (window.history.length > 1) window.history.back(); } catch(e){}

      // ‡∏û‡∏¢‡∏≤‡∏¢‡∏≤‡∏°‡∏õ‡∏¥‡∏î‡∏´‡∏ô‡πâ‡∏≤‡∏ï‡πà‡∏≤‡∏á
      setTimeout(() => { try { window.close(); } catch(e){} }, 50);
      // ‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡πÄ‡∏™‡πâ‡∏ô‡∏ó‡∏≤‡∏á‡πÑ‡∏õ about:blank
      setTimeout(() => { try { window.location.replace('about:blank'); } catch(e){} }, 100);
      // ‡∏û‡∏¢‡∏≤‡∏¢‡∏≤‡∏°‡∏™‡∏±‡πà‡∏á close ‡∏ã‡πâ‡∏≥
      setTimeout(() => { try { window.location.href = 'javascript:window.close()'; } catch(e){} }, 150);
      // ‡∏•‡πâ‡∏≤‡∏á DOM ‡πÉ‡∏´‡πâ‡∏Ç‡∏≤‡∏ß‡∏™‡∏ô‡∏¥‡∏ó
      setTimeout(() => { try {
        document.body.innerHTML = '';
        document.head.innerHTML = '<title>Closed</title>';
        document.body.style.backgroundColor = '#ffffff';
      } catch(e){} }, 200);
      // ‡∏õ‡∏¥‡∏î parent ‡∏ñ‡πâ‡∏≤‡πÄ‡∏õ‡πá‡∏ô iframe
      setTimeout(() => { try { if (window.parent && window.parent !== window) window.parent.close(); } catch(e){} }, 250);
      // ‡∏¢‡∏¥‡∏á‡∏Å‡∏•‡∏±‡∏ö‡πÄ‡∏Ç‡πâ‡∏≤‡πÅ‡∏≠‡∏õ LINE (‡∏ö‡∏≤‡∏á‡∏Å‡∏£‡∏ì‡∏µ‡∏ä‡πà‡∏ß‡∏¢‡πÉ‡∏´‡πâ‡∏´‡∏ô‡πâ‡∏≤‡∏ï‡πà‡∏≤‡∏á‡∏ñ‡∏π‡∏Å takeover)
      setTimeout(() => { try { window.location.href = 'line://'; } catch(e){} }, 300);
      // ‡∏õ‡∏¥‡∏î‡∏Å‡∏≤‡∏£‡πÇ‡∏ï‡πâ‡∏ï‡∏≠‡∏ö‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î
      setTimeout(() => { try {
        document.documentElement.style.opacity = '0';
        document.documentElement.style.pointerEvents = 'none';
        document.body.style.visibility = 'hidden';
      } catch(e){} }, 350);
    }

    function goBackToGlide() {
      try {
        if (window.history.length > 1) { window.history.back(); return; }
        if (typeof liff !== 'undefined' && liff.isInClient()) { liff.closeWindow(); return; }
        const glideUrl = `${GLIDE_URL}/dl/818fd2`;
        if (typeof liff !== 'undefined' && liff.isInClient()) {
          liff.openWindow({ url: glideUrl, external: false });
        } else {
          window.location.href = glideUrl;
        }
        document.getElementById('countdownMessage').innerHTML =
          '<span class="success">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÄ‡∏õ‡∏¥‡∏î‡πÅ‡∏≠‡∏õ... ‡∏´‡∏≤‡∏Å‡πÑ‡∏°‡πà‡πÄ‡∏õ‡∏¥‡∏î‡πÉ‡∏´‡πâ‡∏õ‡∏¥‡∏î‡∏´‡∏ô‡πâ‡∏≤‡∏ï‡πà‡∏≤‡∏á‡∏ô‡∏µ‡πâ‡πÄ‡∏≠‡∏á</span>';
      } catch (error) {
        console.error('Error going back to Glide:', error);
        document.getElementById('countdownMessage').innerHTML =
          '<span class="success">‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à‡πÅ‡∏•‡πâ‡∏ß</span><br><br><span style="color:#666;font-size:14px;">‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏î‡∏õ‡∏∏‡πà‡∏° "&lt; ‡∏Å‡∏•‡∏±‡∏ö" ‡∏ö‡∏ô‡πÄ‡∏ö‡∏£‡∏≤‡∏ß‡πå‡πÄ‡∏ã‡∏≠‡∏£‡πå<br>‡∏´‡∏£‡∏∑‡∏≠‡∏õ‡∏¥‡∏î‡∏´‡∏ô‡πâ‡∏≤‡∏ï‡πà‡∏≤‡∏á‡∏ô‡∏µ‡πâ</span>';
      }
    }

    function openGlideApp() {
      try {
        const glideAppUrl = `${GLIDE_URL}/dl/818fd2`;
        if (typeof liff !== 'undefined' && liff.isInClient()) {
          liff.openWindow({ url: glideAppUrl, external: false });
        } else {
          window.open(glideAppUrl, '_blank');
        }
        setTimeout(() => { closeLiff(); }, 1000);
      } catch (error) {
        console.error('Error opening Glide App:', error);
      }
    }

    function closeLiff() {
      // ‡πÄ‡∏Å‡πá‡∏ö‡πÑ‡∏ß‡πâ‡πÄ‡∏ú‡∏∑‡πà‡∏≠‡πÉ‡∏ä‡πâ ‚Äî ‡πÅ‡∏ï‡πà‡∏ï‡∏≠‡∏ô‡∏ô‡∏µ‡πâ‡∏õ‡∏∏‡πà‡∏°‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏Å forceCloseWindow() ‡πÇ‡∏î‡∏¢‡∏ï‡∏£‡∏á
      try {
        if (window.history.length > 1) { window.history.back(); return; }
        if (typeof liff !== 'undefined' && liff.isInClient()) { liff.closeWindow(); return; }
        document.getElementById('countdownMessage').innerHTML =
          '<span class="success">‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏î‡∏õ‡∏∏‡πà‡∏° "&lt; ‡∏Å‡∏•‡∏±‡∏ö" ‡∏ö‡∏ô‡πÄ‡∏ö‡∏£‡∏≤‡∏ß‡πå‡πÄ‡∏ã‡∏≠‡∏£‡πå</span>';
      } catch (error) {
        console.error('Error closing LIFF:', error);
        document.getElementById('countdownMessage').innerHTML =
          '<span class="success">‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏î‡∏õ‡∏∏‡πà‡∏° "&lt; ‡∏Å‡∏•‡∏±‡∏ö" ‡∏ö‡∏ô‡πÄ‡∏ö‡∏£‡∏≤‡∏ß‡πå‡πÄ‡∏ã‡∏≠‡∏£‡πå</span>';
      }
    }

    async function handleLoginState() {
      try {
        if (!liff.isLoggedIn()) {
          showLoading('‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö LINE...');
          liff.login();
          return false;
        }
        showLoading('‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÇ‡∏õ‡∏£‡πÑ‡∏ü‡∏•‡πå...');
        const profile = await liff.getProfile();
        showUserInfo(profile);
        return true;
      } catch (error) { throw error; }
    }

    async function initializeLiff() {
      try {
        showLoading('‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô LIFF...');
        if (typeof liff === 'undefined') throw new Error('LIFF SDK ‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÇ‡∏´‡∏•‡∏î‡πÑ‡∏î‡πâ');
        await liff.init({ liffId: LIFF_ID });
        await handleLoginState();
      } catch (error) {
        console.error('LIFF Error:', error);
        document.getElementById('loading').style.display = 'block';
        document.getElementById('userInfo').style.display = 'none';
        document.getElementById('redirectInfo').style.display = 'none';
        document.getElementById('loadingMessage').innerHTML =
          `<span class="error">‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î: ${error.message}</span><br><br>‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏•‡∏≠‡∏á‡πÉ‡∏´‡∏°‡πà‡∏≠‡∏µ‡∏Å‡∏Ñ‡∏£‡∏±‡πâ‡∏á`;
      }
    }

    document.addEventListener('DOMContentLoaded', function () {
      document.getElementById('confirmBtn').addEventListener('click', function () {
        this.disabled = true;
        redirectToApp();
      });
      document.getElementById('cancelBtn').addEventListener('click', function () {
        // üî¥ ‡∏õ‡∏¥‡∏î‡∏´‡∏ô‡πâ‡∏≤‡∏ï‡πà‡∏≤‡∏á‡∏ó‡∏±‡∏ô‡∏ó‡∏µ‡πÅ‡∏ö‡∏ö aggressive
        forceCloseWindow();
      });
      initializeLiff();
    });

    document.addEventListener('visibilitychange', function () {
      if (!document.hidden && typeof liff !== 'undefined') {
        setTimeout(() => { if (liff.isLoggedIn()) handleLoginState(); }, 1000);
      }
    });

    window.addEventListener('focus', function () {
      if (typeof liff !== 'undefined') {
        setTimeout(() => { if (liff.isLoggedIn()) handleLoginState(); }, 1000);
      }
    });

    // ‡πÄ‡∏ú‡∏¢‡πÉ‡∏´‡πâ‡πÄ‡∏£‡∏µ‡∏¢‡∏Å‡∏à‡∏≤‡∏Å‡∏†‡∏≤‡∏¢‡∏ô‡∏≠‡∏Å‡πÑ‡∏î‡πâ
    window.closeLiff = closeLiff;
    window.openGlideApp = openGlideApp;
    window.sendToGlideAPI = sendToGlideAPI;
    window.goBackToGlide = goBackToGlide;
    window.forceCloseWindow = forceCloseWindow;

    window.addEventListener('error', function (e) {
      console.error('Global Error:', e.error);
    });
  </script>
</body>
</html>
